<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Quiz Platform: Oceanic Blue</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* Oceanic Blue Theme */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff; /* Light Sky Blue */
            font-size: 1.1rem;
            color: #1e3a8a; /* Dark Blue */
            overflow: hidden;
        }
        .title-font { font-family: 'Baloo 2', cursive; }
        .shape-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        .shape {
            position: absolute;
            background-color: var(--color);
            border-radius: 20%;
            animation: float 35s infinite ease-in-out;
            opacity: 0; /* Start invisible */
        }
        @keyframes float {
            0% {
                transform: translateY(110vh) translateX(var(--start-x)) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% {
                transform: translateY(-100px) translateX(var(--end-x)) rotate(720deg);
                opacity: 0;
            }
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2.5rem;
            border: 2px solid #075985; /* Dark Cyan */
            box-shadow: 8px 8px 0px #38bdf8; /* Sky Blue */
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translate(-4px, -4px);
            box-shadow: 12px 12px 0px #38bdf8;
        }
        .action-button {
            background-color: #0ea5e9; /* Bright Sky Blue */
            color: #ffffff; padding: 0.8rem 1.5rem; border-radius: 0.75rem;
            font-family: 'Baloo 2', cursive;
            font-size: 1.2rem;
            transition: all 0.2s ease; width: 100%;
            border: 2px solid #082f49; /* Darker Blue */
            box-shadow: 4px 4px 0px #082f49;
        }
        .action-button:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px #082f49;
        }
        .action-button:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #082f49;
        }
        .action-button:disabled { background-color: #7dd3fc; box-shadow: 4px 4px 0px #0c4a6e; cursor: not-allowed; }
        .hidden { display: none; }
        .progress-bar-container {
            height: 18px;
            background-color: #e0f2fe;
            border: 2px solid #075985;
            border-radius: 9999px;
            margin-bottom: 1.5rem;
            padding: 3px;
        }
        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #38bdf8, #22d3ee); /* Blue to Cyan gradient */
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .option-button {
            background-color: #fafafa; color: #3f3f46; padding: 0.85rem 1.5rem;
            border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease; width: 100%;
            text-align: left; margin-bottom: 0.75rem; border: 2px solid #d4d4d8;
        }
        .option-button:hover:not(.selected):not(:disabled) {
            transform: translateY(-2px);
            border-color: #0ea5e9;
        }
        .option-button.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .option-button.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .option-button.disabled { cursor: not-allowed; }
        .input-field {
             width: 100%; padding: 0.75rem 1.25rem; border: 2px solid #d4d4d8;
             background-color: #fff; border-radius: 0.75rem; margin-bottom: 1rem;
        }
        .input-field:focus { outline: none; border-color: #0ea5e9; }
    </style>
</head>
<body class="antialiased">
    <div class="shape-container"></div>
    <div class="container max-w-3xl mx-auto p-4 md:p-8">
        <header class="text-center my-10">
            <h1 class="text-6xl title-font text-sky-700">Quiz Adventure</h1>
            <p class="text-2xl mt-2 text-cyan-500">Test Your Wits and Wisdom!</p>
        </header>

        <main>
            <div id="login-container" class="max-w-lg mx-auto space-y-8">
                <div class="card">
                    <h2 class="text-3xl font-bold text-slate-800 mb-4 title-font">Instructions</h2>
                    <ul class="list-disc list-inside space-y-2 text-slate-700">
                        <li>You have one chance to complete the adventure!</li>
                        <li>Each question has a 35-second time limit. Be quick!</li>
                    </ul>
                </div>
                <div class="card">
                    <h2 class="text-3xl font-bold text-slate-800 mb-4 title-font">Start Your Quest</h2>
                    <div>
                        <input type="number" id="student-roll" class="input-field" placeholder="Participant ID (Roll)" required>
                        <input type="password" id="pin-input" class="input-field" placeholder="Access Code (PIN)" required>
                        <button id="login-button" class="action-button mt-2">Start Quiz</button>
                        <p id="error-message" class="text-red-600 mt-4 hidden text-center font-bold"></p>
                    </div>
                </div>
            </div>

            <div id="quiz-section" class="card hidden">
                <div class="flex justify-between items-center mb-4 font-bold">
                    <p class="text-slate-800">Score: <span id="current-score" class="title-font text-2xl text-sky-600">0</span></p>
                    <p class="text-slate-800">Question <span id="question-number">1</span>/<span id="total-questions">0</span></p>
                    <span id="timer" class="title-font text-2xl text-cyan-500"></span>
                </div>
                <div class="progress-bar-container"><div id="progress-bar"></div></div>
                <h2 id="question-text" class="text-2xl font-bold mb-6 text-slate-800 leading-tight">Loading the next question...</h2>
                <div id="options-container"></div>
                <p id="feedback" class="text-center font-bold text-4xl mt-4 hidden title-font"></p>
            </div>

            <div id="result-section" class="card hidden text-center">
                <h2 class="text-5xl title-font mb-4 text-sky-700">Quest Complete!</h2>
                <p class="text-slate-800 font-bold"><strong>Participant ID:</strong> <span id="participant-roll"></span></p>
                <p class="text-3xl font-bold my-4 text-slate-800">Final Score: <span id="final-score">0</span> / <span id="final-total">0</span></p>
                <p id="submission-status" class="font-bold"></p>
                <button id="toggle-review-button" class="action-button mt-6 max-w-sm mx-auto">Answer Review</button>
            </div>

            <div id="answer-review-section" class="hidden mt-8">
                <h3 class="text-4xl title-font text-center mb-6 text-sky-700">Adventure Log</h3>
                <div id="review-container" class="space-y-4"></div>
            </div>
        </main>
        
        <footer class="text-center mt-16 pt-8">
            <p class="text-sm font-bold text-slate-600">Copyright Reserved © 2025 | Fahad Bin Mamun</p>
        </footer>
    </div>

    <script>
        // --- ANIMATION SETUP ---
        const shapeContainer = document.querySelector('.shape-container');
        const colors = ['rgba(14, 165, 233, 0.5)', 'rgba(6, 182, 212, 0.5)', 'rgba(56, 189, 248, 0.4)'];
        for (let i = 0; i < 25; i++) {
            const shape = document.createElement('div');
            shape.classList.add('shape');
            const size = Math.random() * 100 + 20;
            shape.style.width = `${size}px`;
            shape.style.height = `${size}px`;
            shape.style.left = `${Math.random() * 100}vw`;
            shape.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
            shape.style.setProperty('--start-x', `${Math.random() * 40 - 20}vw`);
            shape.style.setProperty('--end-x', `${Math.random() * 40 - 20}vw`);
            shape.style.animationDuration = `${Math.random() * 20 + 15}s`;
            shape.style.animationDelay = `${Math.random() * 15}s`;
            shapeContainer.appendChild(shape);
        }

        // --- Configuration ---
        const SCRIPT_URL = 'আপনার Apps Script URL এখানে পেস্ট করুন';
        const QUESTIONS_PER_QUIZ = 20;
        const TIME_PER_QUESTION = 35; // সেকেন্ড
        const FEEDBACK_DELAY_MS = 1500;

        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const studentRollInput = document.getElementById('student-roll');
        const pinInput = document.getElementById('pin-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const quizSection = document.getElementById('quiz-section');
        const questionNumberSpan = document.getElementById('question-number');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const currentScoreSpan = document.getElementById('current-score');
        const feedbackElement = document.getElementById('feedback');
        const resultSection = document.getElementById('result-section');
        const participantNameSpan = document.getElementById('participant-name');
        const participantRollSpan = document.getElementById('participant-roll');
        const finalScoreSpan = document.getElementById('final-score');
        const finalTotalSpan = document.getElementById('final-total');
        const submissionStatus = document.getElementById('submission-status');
        const toggleReviewButton = document.getElementById('toggle-review-button');
        const answerReviewSection = document.getElementById('answer-review-section');
        const reviewContainer = document.getElementById('review-container');
        const timerSpan = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');

        // --- STATE VARIABLES ---
        let studentInfo = {};
        let timerInterval;
        let submittedAnswers = [];
        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        
        // --- API Communication ---
        async function apiCall(action, data = {}) {
            const payload = { action, ...data };
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                return { result: 'error', message: 'Connection to server failed. Please check your internet connection.' };
            }
        }

        // --- FUNCTIONS ---
        async function handleLogin() {
            const roll = studentRollInput.value.trim();
            const pin = pinInput.value.trim();

            if (!roll || !pin) {
                showError("Participant ID and Access Code are required!");
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = "Loading...";
            errorMessage.classList.add('hidden');
            
            const response = await apiCall('verifyLogin', { roll, pin });

            if (response.result === 'success') {
                studentInfo = { name: response.name, roll: roll };
                loginButton.textContent = "Starting...";
                getQuestionsFromServer();
            } else {
                showError(response.message);
                loginButton.disabled = false;
                loginButton.textContent = "Start Quiz";
            }
        }
        
        async function getQuestionsFromServer() {
            const response = await apiCall('getQuestions');
            if (response.result === 'success' && response.questions.length > 0) {
                allQuestions = response.questions;
                startQuiz();
            } else {
                showError(response.message || "Could not load the adventure!");
                loginButton.disabled = false;
                loginButton.textContent = "Start Quiz";
            }
        }

        function showError(message) {
            errorMessage.textContent = `Oops! ${message}`;
            errorMessage.classList.remove('hidden');
        }

        function startQuiz() {
            loginContainer.parentElement.classList.add('hidden');
            quizSection.classList.remove('hidden');
            currentQuizQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, Math.min(QUESTIONS_PER_QUIZ, allQuestions.length));
            totalQuestionsSpan.textContent = currentQuizQuestions.length;
            loadQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = TIME_PER_QUESTION;
            timerSpan.textContent = timeLeft;
            progressBar.style.width = '100%';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerSpan.textContent = timeLeft;
                const percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                progressBar.style.width = `${percentage}%`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(null, "No Answer (Time Out)");
                }
            }, 1000);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showResult();
                return;
            }

            const questionData = currentQuizQuestions[currentQuestionIndex];
            questionNumberSpan.textContent = currentQuestionIndex + 1;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            feedbackElement.classList.add('hidden');

            const shuffledOptions = [...questionData.options].sort(() => 0.5 - Math.random());
            shuffledOptions.forEach(optionText => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = optionText;
                button.addEventListener('click', () => handleAnswer(button, optionText));
                optionsContainer.appendChild(button);
            });
            startTimer();
        }

        function handleAnswer(button, selectedOptionText) {
            if (optionsContainer.querySelector('.disabled')) return;

            clearInterval(timerInterval);
            const questionData = currentQuizQuestions[currentQuestionIndex];
            const correctOptionText = questionData.answer;
            
            document.querySelectorAll('#options-container .option-button').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === correctOptionText) btn.classList.add('correct');
            });

            submittedAnswers.push({
                question: questionData.question,
                userAnswer: selectedOptionText,
                correctAnswer: correctOptionText,
                explanation: questionData.explanation
            });

            if (selectedOptionText === correctOptionText) {
                score++;
                currentScoreSpan.textContent = score;
                if(button) button.classList.add('correct');
                feedbackElement.textContent = "Awesome!";
                feedbackElement.style.color = '#22c55e';
            } else {
                if(button) button.classList.add('incorrect');
                feedbackElement.textContent = `Whoops!`;
                feedbackElement.style.color = '#ef4444';
            }
            feedbackElement.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, FEEDBACK_DELAY_MS);
        }

        async function showResult() {
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            if(participantNameSpan) participantNameSpan.textContent = studentInfo.name;
            participantRollSpan.textContent = studentInfo.roll;
            finalScoreSpan.textContent = score;
            finalTotalSpan.textContent = currentQuizQuestions.length;
            displayAnswerReview();
            
            submissionStatus.textContent = 'Saving your adventure...';
            submissionStatus.style.color = '#0ea5e9';

            const response = await apiCall('submitResult', {
                studentName: studentInfo.name,
                studentRoll: studentInfo.roll,
                totalScore: `${score} / ${currentQuizQuestions.length}`,
                quizResultsJSON: JSON.stringify(submittedAnswers)
            });

            if (response.result === 'success') {
                submissionStatus.textContent = 'Adventure saved!';
                submissionStatus.style.color = '#22c55e';
            } else {
                submissionStatus.textContent = 'Saving failed: ' + (response.message || 'Unknown error');
                submissionStatus.style.color = '#ef4444';
            }
        }

        function displayAnswerReview() {
            reviewContainer.innerHTML = ''; 
            submittedAnswers.forEach((result, index) => {
                const isCorrect = result.userAnswer === result.correctAnswer;
                const reviewBlock = document.createElement('div');
                reviewBlock.className = 'card p-4';
                reviewBlock.innerHTML = `
                    <p class="font-bold text-lg text-slate-800">${index + 1}. ${result.question}</p>
                    <p class="mt-2 font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}">
                        Your Answer: ${result.userAnswer || 'N/A'}
                    </p>
                    ${!isCorrect ? `<p class="mt-1 font-bold text-green-600">Correct Answer: ${result.correctAnswer}</p>` : ''}
                    <p class="mt-2 text-slate-600 border-t-2 border-dashed border-slate-400 pt-2"><strong>Note:</strong> ${result.explanation || 'N/A'}</p>
                `;
                reviewContainer.appendChild(reviewBlock);
            });
        }

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', handleLogin);
        toggleReviewButton.addEventListener('click', () => {
            answerReviewSection.classList.toggle('hidden');
        });
    </script>
</body>
  </html>
